<h1 id="sqlalchemy">SQLAlchemy<a aria-hidden="true" class="anchor-heading icon-link" href="#sqlalchemy"></a></h1>
<h2 id="sqlalchemy-orm-object-relational-mapper">SQLAlchemy ORM (Object Relational Mapper)<a aria-hidden="true" class="anchor-heading icon-link" href="#sqlalchemy-orm-object-relational-mapper"></a></h2>
<h3 id="what">What<a aria-hidden="true" class="anchor-heading icon-link" href="#what"></a></h3>
<ul>
<li>파이썬에서 데이터베이스를 쉽고 효율적으로 다룰 수 있는 환경을 제공하는 도구</li>
</ul>
<h3 id="how">How<a aria-hidden="true" class="anchor-heading icon-link" href="#how"></a></h3>
<ul>
<li>파이썬과 데이터베이스를 연결해 상위 레벨에서 SQL을 사용할 수 있게 해줌
<ul>
<li>파이썬의 클래스와 클래스의 객체를 관계형 데이터베이스의 테이블과 그 테이블의 레코드로 연관지음</li>
</ul>
</li>
</ul>
<h3 id="note">Note<a aria-hidden="true" class="anchor-heading icon-link" href="#note"></a></h3>
<ul>
<li>만약 저수준의 SQL로 데이터베이와 직접 상호 작용해야하면 SQLAlchemy Core의 SQL Expression Language를 사용할 수 있음</li>
</ul>
<h2 id="sqlalchemy-사용법">SQLAlchemy 사용법<a aria-hidden="true" class="anchor-heading icon-link" href="#sqlalchemy-사용법"></a></h2>
<h3 id="sqlalchemy-설치">SQLAlchemy 설치<a aria-hidden="true" class="anchor-heading icon-link" href="#sqlalchemy-설치"></a></h3>
<pre class="language-shell"><code class="language-shell">pip <span class="token function">install</span> SQLAlchemy
</code></pre>
<h3 id="데이터베이스에-접속">데이터베이스에 접속<a aria-hidden="true" class="anchor-heading icon-link" href="#데이터베이스에-접속"></a></h3>
<pre class="language-python"><code class="language-python"><span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>orm <span class="token keyword">import</span> scoped_session<span class="token punctuation">,</span> sessionmaker<span class="token punctuation">,</span> relationship<span class="token punctuation">,</span> backref

<span class="token comment"># 데이터베이스에 접속하기 위해 데이터베이스 엔진을 추상화한 Engine 객체를 얻는다</span>
engine <span class="token operator">=</span> sa<span class="token punctuation">.</span>create_engine<span class="token punctuation">(</span><span class="token string">'mysql+pymysql://root:password@34.239.103.110/testdb'</span><span class="token punctuation">)</span> <span class="token comment">#'sqlite:///site.db'</span>

<span class="token comment"># 연결된 데이터베이스를 다루기 위한 세션 객체를 얻는다.</span>
<span class="token comment"># 이 세션을 이용해 데이터베이스 쿼리, 커넥션, 트랜잭션 등 데이터베이스와 관련된 모든 작업을 처리한다. bind 인자에 연결할 데이터베이스 엔진을 설정한다.</span>
session <span class="token operator">=</span> scoped_session<span class="token punctuation">(</span>sessionmaker<span class="token punctuation">(</span>bind<span class="token operator">=</span>engine<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
<h3 id="base-클래스-만들기">Base 클래스 만들기<a aria-hidden="true" class="anchor-heading icon-link" href="#base-클래스-만들기"></a></h3>
<pre class="language-python"><code class="language-python"><span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>ext<span class="token punctuation">.</span>declarative <span class="token keyword">import</span> declarative_base

Base <span class="token operator">=</span> declarative_base<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<h3 id="model-만들기">Model 만들기<a aria-hidden="true" class="anchor-heading icon-link" href="#model-만들기"></a></h3>
<pre class="language-python"><code class="language-python"><span class="token keyword">import</span> sqlalchemy <span class="token keyword">as</span> sa

<span class="token comment"># users 테이블을 아래와 같이 모델링한다</span>
<span class="token keyword">class</span> <span class="token class-name">User</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># User 클래스와 매핑될 물리적인 데이터베이스 테이블명</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">'user'</span>
    <span class="token builtin">id</span> <span class="token operator">=</span> sa<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>sa<span class="token punctuation">.</span>Integer<span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    username <span class="token operator">=</span> sa<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>sa<span class="token punctuation">.</span>String<span class="token punctuation">(</span><span class="token number">45</span><span class="token punctuation">)</span><span class="token punctuation">,</span> unique<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    email <span class="token operator">=</span> sa<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>sa<span class="token punctuation">.</span>String<span class="token punctuation">(</span><span class="token number">80</span><span class="token punctuation">)</span><span class="token punctuation">,</span> unique<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    password <span class="token operator">=</span> sa<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>sa<span class="token punctuation">.</span>String<span class="token punctuation">(</span><span class="token number">45</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 객체에 어떤 값이 들어있는지 출력 (디버깅, 로깅 용)</span>
    <span class="token keyword">def</span> <span class="token function">__repr__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f"User('</span><span class="token interpolation"><span class="token punctuation">{</span>self<span class="token punctuation">.</span>user_name<span class="token punctuation">}</span></span><span class="token string">', '</span><span class="token interpolation"><span class="token punctuation">{</span>self<span class="token punctuation">.</span>email<span class="token punctuation">}</span></span><span class="token string">')"</span></span>
</code></pre>
<h3 id="데이터베이스-테이블-생성">데이터베이스 테이블 생성<a aria-hidden="true" class="anchor-heading icon-link" href="#데이터베이스-테이블-생성"></a></h3>
<pre class="language-python"><code class="language-python"><span class="token comment"># 앞서 초기화한대로 데이터베이스 테이블을 생성한다.</span>
Base<span class="token punctuation">.</span>metadata<span class="token punctuation">.</span>create_all<span class="token punctuation">(</span>engine<span class="token punctuation">)</span>
</code></pre>
<p>SQLAlechemy에서 자동으로 아래와 같은 데이터베이스 테이블 스키마를 새성하는 SQL 문을 실행한 것처럼 테이블을 만들어준다.</p>
<pre class="language-sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> users<span class="token punctuation">(</span>
id <span class="token keyword">INTEGER</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
username <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
email <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">80</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
password <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">55</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token keyword">UNIQUE</span> <span class="token punctuation">(</span>username<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<h2 id="references">References<a aria-hidden="true" class="anchor-heading icon-link" href="#references"></a></h2>
<ul>
<li>주성식, 홍성민, 파이썬 웹 프로그래밍, 위키북스</li>
<li><a href="https://docs.sqlalchemy.org/en/latest/orm/examples.html">https://docs.sqlalchemy.org/en/latest/orm/examples.html</a></li>
</ul>
<h2 id="note-1">Note<a aria-hidden="true" class="anchor-heading icon-link" href="#note-1"></a></h2>
<p>아래 자료도 추가 확인할 것</p>
<ul>
<li><a href="https://www.sqlalchemy.org/">https://www.sqlalchemy.org/</a></li>
<li><a href="http://flask-sqlalchemy.pocoo.org/2.3/">http://flask-sqlalchemy.pocoo.org/2.3/</a></li>
</ul>